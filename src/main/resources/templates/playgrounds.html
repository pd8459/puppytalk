<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>PuppyTalk - ë°˜ë ¤ê²¬ ë†€ì´í„° ì§€ë„</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        #map { width: 100%; height: 600px; }
        .playground-list { height: 600px; overflow-y: auto; }
        .list-group-item { cursor: pointer; }
        .list-group-item:hover { background-color: #f8f9fa; }
    </style>
    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=3e76fe79c83a7419b49f04db157ee82b"></script>
</head>
<body>
<div th:replace="~{fragments/navbar :: navbar}"></div>

<div class="container mt-4">
    <h2 class="mb-3 text-center">ìš°ë¦¬ ë™ë„¤ ë°˜ë ¤ê²¬ ë†€ì´í„° ì°¾ê¸° ğŸ—ºï¸</h2>
    <div class="text-center mb-3">
        <button id="find-me-btn" class="btn btn-success">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-geo-alt-fill" viewBox="0 0 16 16">
                <path d="M8 16s6-5.686 6-10A6 6 0 0 0 2 6c0 4.314 6 10 6 10zm0-7a3 3 0 1 1 0-6 3 3 0 0 1 0 6z"/>
            </svg>
            ë‚´ ìœ„ì¹˜ ì¤‘ì‹¬ìœ¼ë¡œ ë³´ê¸°
        </button>
    </div>
    <div class="row">
        <div class="col-md-8">
            <div id="map" class="rounded shadow"></div>
        </div>
        <div class="col-md-4">
            <div id="playground-list" class="list-group playground-list shadow-sm"></div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        kakao.maps.load(async () => {
            try {
                const response = await fetch('/api/playgrounds');
                if (!response.ok) throw new Error('ë†€ì´í„° ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
                const playgrounds = await response.json();
                initializeMap(playgrounds);
            } catch (error) {
                console.error(error);
                document.getElementById('map').innerHTML = `<div class="alert alert-danger">${error.message}</div>`;
            }
        });
    });

    function initializeMap(playgrounds) {
        const mapContainer = document.getElementById('map');
        const listContainer = document.getElementById('playground-list');
        const defaultPosition = new kakao.maps.LatLng(37.566826, 126.9786567);

        const mapOption = {
            center: defaultPosition,
            level: 10
        };
        const map = new kakao.maps.Map(mapContainer, mapOption);
        let currentInfoWindow = null;

        document.getElementById('find-me-btn').addEventListener('click', () => {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(position => {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;
                    const userPosition = new kakao.maps.LatLng(lat, lon);

                    // ì§€ë„ ë ˆë²¨ì„ 6ìœ¼ë¡œ ë³€ê²½í•˜ì—¬ ì¡°ê¸ˆ ë” ì¶•ì†Œí•©ë‹ˆë‹¤.
                    map.setLevel(6, { animate: true });
                    map.panTo(userPosition);

                    new kakao.maps.Marker({
                        map: map,
                        position: userPosition,
                        title: 'ë‚´ ìœ„ì¹˜'
                    });
                }, error => {
                    console.error(error);
                    alert('ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                });
            } else {
                alert('ì´ ë¸Œë¼ìš°ì €ì—ì„œëŠ” ìœ„ì¹˜ ì •ë³´ ê¸°ëŠ¥ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
            }
        });

        playgrounds.forEach(pg => {
            if (!pg.latitude || !pg.longitude) return;

            const position = new kakao.maps.LatLng(pg.latitude, pg.longitude);
            const marker = new kakao.maps.Marker({
                position: position,
                title: pg.name
            });
            marker.setMap(map);

            const content = `
                <div style="padding: 10px; line-height: 1.5; font-size: 13px; white-space: nowrap;">
                    <strong>${pg.name}</strong><br>
                    ${pg.address}<br>
                    <hr style="margin: 4px 0;">
                    <strong>ìš´ì˜ì‹œê°„:</strong> ${pg.operatingHours || 'ì •ë³´ ì—†ìŒ'}<br>
                    <strong>ì—°ë½ì²˜:</strong> ${pg.contact || 'ì •ë³´ ì—†ìŒ'}
                </div>
            `;

            const infowindow = new kakao.maps.InfoWindow({
                content: content,
                removable: true
            });

            const openInfoWindow = () => {
                if (currentInfoWindow) {
                    currentInfoWindow.close();
                }
                infowindow.open(map, marker);
                currentInfoWindow = infowindow;
            }

            kakao.maps.event.addListener(marker, 'click', openInfoWindow);

            const listItem = document.createElement('a');
            listItem.href = '#';
            listItem.className = 'list-group-item list-group-item-action';
            listItem.innerHTML = `
                <h6 class="mb-1">${pg.name}</h6>
                <p class="mb-1 small text-muted">${pg.address || ''}</p>
            `;
            listItem.addEventListener('click', (e) => {
                e.preventDefault();
                map.panTo(position);
                openInfoWindow();
            });
            listContainer.appendChild(listItem);
        });
    }
</script>
</body>
</html>