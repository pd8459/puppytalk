<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>PuppyTalk - ë°˜ë ¤ê²¬ ë†€ì´í„° ì§€ë„</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        #map { width: 100%; height: 600px; }
        .playground-list { height: 545px; overflow-y: auto; }
        .list-group-item { cursor: pointer; }
        .list-group-item:hover { background-color: #f8f9fa; }
    </style>
    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=3e76fe79c83a7419b49f04db157ee82b"></script>
</head>
<body>
<div th:replace="~{fragments/navbar :: navbar}"></div>
<div class="container mt-4">
    <h2 class="mb-3 text-center">ìš°ë¦¬ ë™ë„¤ ë°˜ë ¤ê²¬ ë†€ì´í„° ì°¾ê¸° ğŸ—ºï¸</h2>
    <div class="text-center mb-3">
        <button id="find-me-btn" class="btn btn-success">ë‚´ ìœ„ì¹˜ ì¤‘ì‹¬ìœ¼ë¡œ ë³´ê¸°</button>
    </div>
    <div class="row">
        <div class="col-md-8">
            <div id="map" class="rounded shadow"></div>
        </div>
        <div class="col-md-4">
            <div class="input-group mb-3 shadow-sm">
                <input type="text" id="search-keyword" class="form-control" placeholder="ì§€ì—­ ë˜ëŠ” ë†€ì´í„° ì´ë¦„ ê²€ìƒ‰">
                <button id="search-btn" class="btn btn-primary">ê²€ìƒ‰</button>
            </div>
            <div id="playground-list" class="list-group playground-list"></div>
        </div>
    </div>
</div>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        kakao.maps.load(async () => {
            const allPlaygrounds = await fetchPlaygrounds();
            if (allPlaygrounds) {
                initializeMap(allPlaygrounds);
            }
        });
    });
    async function fetchPlaygrounds(keyword = '') {
        const url = keyword ? `/api/playgrounds/search?keyword=${keyword}` : '/api/playgrounds';
        try {
            const response = await fetch(url);
            if (!response.ok) throw new Error('ë†€ì´í„° ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
            return await response.json();
        } catch (error) {
            console.error(error);
            document.getElementById('map').innerHTML = `<div class="alert alert-danger">${error.message}</div>`;
            return null;
        }
    }
    function initializeMap(initialPlaygrounds) {
        const mapContainer = document.getElementById('map');
        const defaultPosition = new kakao.maps.LatLng(37.566826, 126.9786567);
        const map = new kakao.maps.Map(mapContainer, { center: defaultPosition, level: 10 });
        let currentInfoWindow = null;
        let currentSelectedMarker = null;
        const markers = [];
        const defaultMarkerImage = new kakao.maps.MarkerImage(
            'http://t1.daumcdn.net/mapjsapi/images/marker.png',
            new kakao.maps.Size(29, 42)
        );
        const selectedMarkerImage = new kakao.maps.MarkerImage(
            'https://maps.google.com/mapfiles/ms/icons/red-dot.png',
            new kakao.maps.Size(32, 32)
        );
        function displayMarkersAndList(playgrounds) {
            const listContainer = document.getElementById('playground-list');
            listContainer.innerHTML = '';
            markers.forEach(marker => marker.setMap(null));
            markers.length = 0;
            if (playgrounds.length === 0) {
                listContainer.innerHTML = '<p class="text-center p-3">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }
            playgrounds.forEach(pg => {
                if (!pg.latitude || !pg.longitude) return;
                const position = new kakao.maps.LatLng(pg.latitude, pg.longitude);
                const marker = new kakao.maps.Marker({
                    position: position,
                    title: pg.name,
                    image: defaultMarkerImage
                });
                marker.setMap(map);
                markers.push(marker);
                const infowindow = new kakao.maps.InfoWindow({
                    content: `<div style="padding:10px; width:280px;"><strong>${pg.name}</strong><br>${pg.address}</div>`,
                    removable: true
                });
                const selectMarker = () => {
                    if (currentSelectedMarker) {
                        currentSelectedMarker.setImage(defaultMarkerImage);
                    }
                    marker.setImage(selectedMarkerImage);
                    currentSelectedMarker = marker;
                    if (currentInfoWindow) currentInfoWindow.close();
                    infowindow.open(map, marker);
                    currentInfoWindow = infowindow;
                };
                kakao.maps.event.addListener(marker, 'click', selectMarker);
                const listItem = document.createElement('a');
                listItem.href = '#';
                listItem.className = 'list-group-item list-group-item-action';
                listItem.innerHTML = `<h6 class="mb-1">${pg.name}</h6><p class="mb-1 small text-muted">${pg.address || ''}</p>`;
                listItem.addEventListener('click', (e) => {
                    e.preventDefault();
                    map.panTo(position);
                    selectMarker();
                });
                listContainer.appendChild(listItem);
            });
            if (markers.length > 0) {
                const bounds = new kakao.maps.LatLngBounds();
                markers.forEach(marker => bounds.extend(marker.getPosition()));
                map.setBounds(bounds);
            }
        }
        document.getElementById('search-btn').addEventListener('click', async () => {
            const keyword = document.getElementById('search-keyword').value;
            const searchResult = await fetchPlaygrounds(keyword);
            if (searchResult) displayMarkersAndList(searchResult);
        });
        document.getElementById('search-keyword').addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                document.getElementById('search-btn').click();
            }
        });
        document.getElementById('find-me-btn').addEventListener('click', () => {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(position => {
                    const userPosition = new kakao.maps.LatLng(position.coords.latitude, position.coords.longitude);
                    map.setLevel(6, { animate: true });
                    map.panTo(userPosition);
                    const markerImage = new kakao.maps.MarkerImage('https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/markerStar.png', new kakao.maps.Size(24, 35));
                    new kakao.maps.Marker({ map: map, position: userPosition, title: 'ë‚´ ìœ„ì¹˜', image: markerImage });
                }, () => alert('ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'));
            } else {
                alert('ì´ ë¸Œë¼ìš°ì €ì—ì„œëŠ” ìœ„ì¹˜ ì •ë³´ ê¸°ëŠ¥ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
            }
        });
        displayMarkersAndList(initialPlaygrounds);
    }
</script>
</body>
</html>