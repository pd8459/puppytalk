<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>PuppyTalk - 마이페이지</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<div th:replace="~{fragments/navbar :: navbar}"></div>

<div class="container mt-4">
    <h2 class="mb-3" id="nickname-header">마이페이지</h2>

    <ul class="nav nav-tabs" id="myTab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="posts-tab" data-bs-toggle="tab" data-bs-target="#posts-tab-pane" type="button" role="tab">내가 쓴 글</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="comments-tab" data-bs-toggle="tab" data-bs-target="#comments-tab-pane" type="button" role="tab">내가 쓴 댓글</button>
        </li>
    </ul>

    <div class="tab-content" id="myTabContent">
        <div class="tab-pane fade show active" id="posts-tab-pane" role="tabpanel">
            <div id="my-posts-list" class="list-group mt-3"></div>
            <nav id="posts-pagination" class="mt-3"></nav>
        </div>
        <div class="tab-pane fade" id="comments-tab-pane" role="tabpanel">
            <div id="my-comments-list" class="list-group mt-3"></div>
            <nav id="comments-pagination" class="mt-3"></nav>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
    const token = localStorage.getItem('jwt');

    document.addEventListener('DOMContentLoaded', async () => {
        if (!token) {
            alert('로그인이 필요합니다.');
            window.location.href = '/login';
            return;
        }

        try {
            const res = await fetch('/api/users/me', {
                headers: { 'Authorization': 'Bearer ' + token }
            });
            if (!res.ok) throw new Error('인증 정보가 유효하지 않습니다.');
            const data = await res.json();
            document.getElementById('nickname-header').textContent = `${data.nickname}님의 활동 내역`;
        } catch (err) {
            alert(err.message);
            window.location.href = '/login';
            return;
        }

        fetchMyPosts(0);
    });

    document.getElementById('posts-tab').addEventListener('click', () => fetchMyPosts(0));
    document.getElementById('comments-tab').addEventListener('click', () => fetchMyComments(0));

    async function fetchMyPosts(page) {
        const response = await fetch(`/api/mypage/posts?page=${page}`, {
            headers: { 'Authorization': 'Bearer ' + token }
        });
        if (response.ok) {
            const pageData = await response.json();
            renderList(pageData, 'posts');
        } else {
            handleAuthError();
        }
    }

    async function fetchMyComments(page) {
        const response = await fetch(`/api/mypage/comments?page=${page}`, {
            headers: { 'Authorization': 'Bearer ' + token }
        });
        if (response.ok) {
            const pageData = await response.json();
            renderList(pageData, 'comments');
        } else {
            handleAuthError();
        }
    }

    function renderList(pageData, type) {
        const listId = type === 'posts' ? 'my-posts-list' : 'my-comments-list';
        const paginationId = type === 'posts' ? 'posts-pagination' : 'comments-pagination';
        const fetchFunction = type === 'posts' ? fetchMyPosts : fetchMyComments;
        const listContainer = document.getElementById(listId);
        listContainer.innerHTML = '';

        pageData.content.forEach(item => {
            const link = document.createElement('a');
            link.className = 'list-group-item list-group-item-action';
            const date = new Date(item.createdAt).toLocaleString('ko-KR');
            if (type === 'posts') {
                link.href = `/post-detail?id=${item.id}`;
                link.innerHTML = `<h5 class="mb-1">${item.title}</h5><small>작성일: ${date}</small>`;
            } else {
                link.href = `/post-detail?id=${item.postId}`;
                link.innerHTML = `<p class="mb-1">${item.content}</p><small>작성일: ${date}</small>`;
            }
            listContainer.appendChild(link);
        });

        renderPagination(pageData, paginationId, fetchFunction);
    }

    function renderPagination(pageData, containerId, fetchFunction) {
        const container = document.getElementById(containerId);
        container.innerHTML = '';
        if (pageData.totalPages <= 1) return;

        const ul = document.createElement('ul');
        ul.className = 'pagination justify-content-center';
        for (let i = 0; i < pageData.totalPages; i++) {
            const li = document.createElement('li');
            li.className = `page-item ${i === pageData.number ? 'active' : ''}`;
            const a = document.createElement('a');
            a.className = 'page-link';
            a.href = '#';
            a.textContent = i + 1;
            a.onclick = (e) => {
                e.preventDefault();
                fetchFunction(i);
            };
            li.appendChild(a);
            ul.appendChild(li);
        }
        container.appendChild(ul);
    }

    function handleAuthError() {
        alert('인증 정보가 유효하지 않습니다. 다시 로그인해주세요.');
        window.location.href = '/login';
    }
</script>
</body>
</html>
