<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>PuppyTalk - 상품 문의</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.6.1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
        .chat-container { max-width: 800px; margin: auto; height: 90vh; display: flex; flex-direction: column; }
        .chat-header { padding: 1rem; background-color: #fff3cd; border-bottom: 1px solid #ffeeba; }
        .chat-box { flex: 1; overflow-y: auto; padding: 1rem; background-color: #fff; }
        .message { display: flex; margin-bottom: 1rem; }
        .message.outgoing { justify-content: flex-end; }
        .message-bubble { max-width: 70%; padding: 0.6rem 1rem; border-radius: 15px; }
        .outgoing .message-bubble { background-color: #ffc107; color: black; }
        .incoming .message-bubble { background-color: #f8f9fa; border: 1px solid #ddd; }
    </style>
</head>
<body>
<div th:replace="~{fragments/navbar :: navbar}"></div>

<div class="container mt-3 chat-container border rounded">
    <div class="chat-header d-flex align-items-center">
        <a href="/shop/list" class="btn btn-sm btn-outline-warning me-3">← 나가기</a>
        <h5 class="mb-0 fw-bold" id="chat-title">연결 중...</h5>
    </div>

    <div id="chat-box" class="chat-box"></div>

    <form id="reply-form" class="p-3 border-top bg-light">
        <div class="input-group">
            <input type="text" id="reply-content" class="form-control" placeholder="메시지 입력..." required>
            <button class="btn btn-warning" type="submit">전송</button>
        </div>
    </form>
</div>

<script th:inline="javascript">
    const conversationId = [[${conversationId}]];
    const urlParams = new URLSearchParams(window.location.search);
    let targetFromUrl = urlParams.get('target'); // URL에서 상대방 ID 가져오기

    let stompClient = null;
    let currentUsername = '';
    let otherUserUsername = '';

    window.addEventListener('DOMContentLoaded', async () => {
        await getMyProfile();
        await loadMessages();
        connectWebSocket();
    });

    async function getMyProfile() {
        try {
            const res = await fetch('/api/profile');
            if(res.ok) {
                const user = await res.json();
                currentUsername = user.username;
            }
        } catch(e) {}
    }

    async function loadMessages() {
        try {
            const res = await fetch(`/api/messages/${conversationId}`);
            if(!res.ok) return;
            const messages = await res.json();

            if(messages.length > 0) {
                // 기존 메시지가 있으면 그 정보를 우선 사용
                const first = messages[0];
                if(first.senderUsername === currentUsername) {
                    otherUserUsername = first.receiverUsername;
                    document.getElementById('chat-title').textContent = `To. ${first.receiverNickname}`;
                } else {
                    otherUserUsername = first.senderUsername;
                    document.getElementById('chat-title').textContent = `From. ${first.senderNickname}`;
                }
            } else {
                // 메시지가 없으면 URL 파라미터 사용
                if(targetFromUrl) {
                    otherUserUsername = targetFromUrl;
                    document.getElementById('chat-title').textContent = `To. ${targetFromUrl}`;
                } else {
                    otherUserUsername = "1111"; // 최후의 수단 (관리자)
                    document.getElementById('chat-title').textContent = "판매자에게 문의하기";
                }
            }

            const chatBox = document.getElementById('chat-box');
            chatBox.innerHTML = '';
            messages.forEach(msg => appendMessage(msg));
            chatBox.scrollTop = chatBox.scrollHeight;
        } catch(e) {}
    }

    function connectWebSocket() {
        const socket = new SockJS('/ws-stomp');
        stompClient = Stomp.over(socket);
        stompClient.debug = null;
        stompClient.connect({}, function() {
            stompClient.subscribe(`/topic/chat/${conversationId}`, function(msg) {
                appendMessage(JSON.parse(msg.body));
                const chatBox = document.getElementById('chat-box');
                chatBox.scrollTop = chatBox.scrollHeight;
            });
        });
    }

    function appendMessage(msg) {
        const isMe = msg.senderUsername === currentUsername;
        const div = document.createElement('div');
        div.className = `message ${isMe ? 'outgoing' : 'incoming'}`;
        div.innerHTML = `<div class="message-bubble">${msg.content}</div>`;
        document.getElementById('chat-box').appendChild(div);
    }

    document.getElementById('reply-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const input = document.getElementById('reply-content');
        if(!input.value.trim()) return;

        try {
            await fetch(`/api/messages/${otherUserUsername}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({content: input.value})
            });
            input.value = '';
        } catch(e) { alert('전송 실패'); }
    });
</script>
</body>
</html>