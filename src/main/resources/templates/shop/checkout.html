<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>PuppyTalk - ì£¼ë¬¸ì„œ ì‘ì„±</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
    <script src="https://cdn.iamport.kr/v1/iamport.js"></script>
</head>
<body>
<div th:replace="~{fragments/navbar :: navbar}"></div>

<div class="container mt-5 mb-5" style="max-width: 900px;">
    <h2 class="mb-4 fw-bold">ğŸ“ ì£¼ë¬¸ì„œ ì‘ì„±</h2>

    <div class="row">
        <div class="col-md-7">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-white fw-bold">ğŸ“ ë°°ì†¡ì§€ ì •ë³´</div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">ë°›ëŠ” ì‚¬ëŒ</label>
                        <input type="text" id="recipient" class="form-control" th:value="${user.nickname}">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">ì—°ë½ì²˜</label>
                        <input type="text" id="phone" class="form-control" placeholder="010-0000-0000">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">ì£¼ì†Œ</label>
                        <div class="input-group mb-2">
                            <input type="text" id="zipcode" class="form-control" placeholder="ìš°í¸ë²ˆí˜¸" readonly>
                            <button type="button" class="btn btn-outline-secondary" onclick="execDaumPostcode()">ì£¼ì†Œ ê²€ìƒ‰</button>
                        </div>
                        <input type="text" id="address" class="form-control mb-2" placeholder="ê¸°ë³¸ ì£¼ì†Œ" readonly>
                        <input type="text" id="detailAddress" class="form-control" placeholder="ìƒì„¸ ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">ë°°ì†¡ ìš”ì²­ì‚¬í•­</label>
                        <select id="requestMemo" class="form-select">
                            <option value="ë¬¸ ì•ì— ë†“ì•„ì£¼ì„¸ìš”">ë¬¸ ì•ì— ë†“ì•„ì£¼ì„¸ìš”</option>
                            <option value="ë°°ì†¡ ì „ ì—°ë½ë°”ëë‹ˆë‹¤">ë°°ì†¡ ì „ ì—°ë½ë°”ëë‹ˆë‹¤</option>
                            <option value="ë¶€ì¬ ì‹œ ê²½ë¹„ì‹¤ì— ë§¡ê²¨ì£¼ì„¸ìš”">ë¶€ì¬ ì‹œ ê²½ë¹„ì‹¤ì— ë§¡ê²¨ì£¼ì„¸ìš”</option>
                            <option value="ì§ì ‘ ì…ë ¥">ì§ì ‘ ì…ë ¥</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="card shadow-sm mb-4">
                <div class="card-header bg-white fw-bold">ğŸ“¦ ì£¼ë¬¸ ìƒí’ˆ</div>
                <ul class="list-group list-group-flush">
                    <li th:each="item : ${cartItems}" class="list-group-item d-flex align-items-center">
                        <img th:src="${item.product.thumbnailUrl}" width="60" height="60" style="object-fit: cover;" class="rounded me-3 border">
                        <div class="flex-grow-1">
                            <div th:text="${item.product.name}" class="fw-bold">ìƒí’ˆëª…</div>
                            <small class="text-muted">
                                <span th:text="${#numbers.formatInteger(item.product.currentPrice, 0, 'COMMA')}">10,000</span>ì›
                                x <span th:text="${item.count}">1</span>ê°œ
                            </small>
                        </div>
                        <span class="fw-bold text-end" th:text="${#numbers.formatInteger(item.product.currentPrice * item.count, 0, 'COMMA')} + 'ì›'">
                            10,000ì›
                        </span>
                    </li>
                </ul>
            </div>
        </div>

        <div class="col-md-5">
            <div class="card shadow-sm position-sticky" style="top: 20px;">
                <div class="card-header bg-white fw-bold">ğŸ’° ê²°ì œ ê¸ˆì•¡</div>
                <div class="card-body">
                    <div class="d-flex justify-content-between mb-2">
                        <span>ì´ ìƒí’ˆê¸ˆì•¡</span>
                        <span th:text="${#numbers.formatInteger(totalPrice, 0, 'COMMA')} + 'ì›'">0ì›</span>
                    </div>
                    <div class="d-flex justify-content-between mb-3 text-muted">
                        <span>ë°°ì†¡ë¹„</span>
                        <span>0ì› (ë¬´ë£Œë°°ì†¡)</span>
                    </div>
                    <hr>
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <strong class="fs-5">ìµœì¢… ê²°ì œê¸ˆì•¡</strong>
                        <strong class="fs-4 text-primary" th:text="${#numbers.formatInteger(totalPrice, 0, 'COMMA')} + 'ì›'">0ì›</strong>
                    </div>
                    <button onclick="requestPayment()" class="btn btn-primary w-100 btn-lg fw-bold">ê²°ì œí•˜ê¸° (ì¹´ì¹´ì˜¤í˜ì´)</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script th:inline="javascript">
    var IMP = window.IMP;
    IMP.init("imp22747340");

    const totalPrice = [[${totalPrice}]];
    const buyerEmail = [[${user.email}]];
    const buyerName = [[${user.nickname}]];

    let orderName = [[${cartItems[0].product.name}]];
    const cartSize = [[${cartItems.size()}]];
    if (cartSize > 1) {
        orderName += ' ì™¸ ' + (cartSize - 1) + 'ê±´';
    }

    function execDaumPostcode() {
        new daum.Postcode({
            oncomplete: function(data) {
                var addr = data.userSelectedType === 'R' ? data.roadAddress : data.jibunAddress;
                document.getElementById('zipcode').value = data.zonecode;
                document.getElementById("address").value = addr;
                document.getElementById("detailAddress").focus();
            }
        }).open();
    }

    async function requestPayment() {
        const recipient = document.getElementById('recipient').value;
        const phone = document.getElementById('phone').value;
        const address = document.getElementById('address').value;
        const detailAddress = document.getElementById('detailAddress').value;

        if (!recipient || !phone || !address || !detailAddress) {
            alert("ë°°ì†¡ì§€ ì •ë³´ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            return;
        }

        if (!confirm("ì¹´ì¹´ì˜¤í˜ì´ë¡œ ê²°ì œë¥¼ ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

        const token = localStorage.getItem('Authorization');

        try {
            const orderResponse = await fetch('/api/shop/order', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': token
                },
                body: JSON.stringify({
                    recipient: recipient,
                    phoneNumber: phone,
                    address: address + " " + detailAddress
                })
            });

            if (!orderResponse.ok) {
                alert("ì£¼ë¬¸ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                return;
            }

            const orderData = await orderResponse.json();
            const merchantUid = "ORD-" + orderData.orderId + "-" + new Date().getTime();

            IMP.request_pay({
                pg: "kakaopay",
                pay_method: "card",
                merchant_uid: merchantUid,
                name: orderName,
                amount: totalPrice,
                buyer_email: buyerEmail,
                buyer_name: buyerName,
                buyer_tel: phone,
                buyer_addr: address + " " + detailAddress,
                buyer_postcode: document.getElementById('zipcode').value
            }, async function (rsp) {
                if (rsp.success) {
                    try {
                        const verifyResponse = await fetch('/api/shop/payment/verify', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': token
                            },
                            body: JSON.stringify({
                                imp_uid: rsp.imp_uid,
                                merchant_uid: rsp.merchant_uid,
                                paid_amount: rsp.paid_amount,
                                pay_method: rsp.pay_method,
                                status: rsp.status
                            })
                        });

                        if (verifyResponse.ok) {
                            alert("ê²°ì œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!");
                            window.location.href = "/shop/orders";
                        } else {
                            const errorText = await verifyResponse.text();
                            alert("ê²°ì œ ê²€ì¦ ì‹¤íŒ¨: " + errorText);
                        }
                    } catch (e) {
                        alert("ê²°ì œ ê²€ì¦ ì¤‘ ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                    }
                } else {
                    alert("ê²°ì œì— ì‹¤íŒ¨í•˜ì˜€ìŠµë‹ˆë‹¤.\n" + rsp.error_msg);
                }
            });

        } catch (e) {
            console.error(e);
            alert("ì„œë²„ í†µì‹  ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
    }
</script>
</body>
</html>