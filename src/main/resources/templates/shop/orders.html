<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>PuppyTalk - ì£¼ë¬¸ ë‚´ì—­</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .item-img { width: 80px; height: 80px; object-fit: cover; border-radius: 8px; border: 1px solid #eee; }
        .order-card { border: 1px solid #ddd; border-left: 5px solid #0d6efd; transition: 0.2s; }
        .order-card:hover { box-shadow: 0 4px 15px rgba(0,0,0,0.1); }

        .status-ORDER { border-left-color: #0d6efd; }
        .status-PREPARING { border-left-color: #ffc107; }
        .status-SHIPPING { border-left-color: #198754; }
        .status-COMPLETED { border-left-color: #6c757d; background-color: #f8f9fa; }
        .status-CANCEL_REQUESTED { border-left-color: #fd7e14; background-color: #fff3cd; }
        .status-CANCEL { border-left-color: #dc3545; background-color: #f8d7da; opacity: 0.8; }
    </style>
</head>
<body>
<div th:replace="~{fragments/navbar :: navbar}"></div>

<div class="container mt-5 mb-5" style="max-width: 800px;">
    <h2 class="mb-4 fw-bold">ğŸ“¦ ë‚´ ì£¼ë¬¸ ë‚´ì—­</h2>

    <div id="order-list"></div>

    <div id="empty-message" class="text-center py-5 d-none">
        <h4 class="text-muted">ì•„ì§ ì£¼ë¬¸í•œ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</h4>
        <p class="mb-4">ê°•ì•„ì§€ë¥¼ ìœ„í•œ ì„ ë¬¼ì„ ê³¨ë¼ë³´ì„¸ìš”!</p>
        <a href="/shop/list" class="btn btn-primary btn-lg">ì‡¼í•‘í•˜ëŸ¬ ê°€ê¸°</a>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const StatusMap = {
        'ORDER': 'ê²°ì œì™„ë£Œ',
        'PREPARING': 'ìƒí’ˆì¤€ë¹„ì¤‘',
        'SHIPPING': 'ë°°ì†¡ì¤‘',
        'COMPLETED': 'ë°°ì†¡ì™„ë£Œ',
        'CANCEL_REQUESTED': 'í™˜ë¶ˆìš”ì²­ì¤‘',
        'CANCEL': 'ì·¨ì†Œ/í™˜ë¶ˆì™„ë£Œ'
    };

    window.addEventListener('DOMContentLoaded', loadOrders);

    async function loadOrders() {
        try {
            const response = await fetch('/api/shop/order/list');
            if (response.status === 401 || response.status === 403) {
                alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                location.href = '/login';
                return;
            }
            if (!response.ok) throw new Error('ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨');

            const orders = await response.json();
            const listContainer = document.getElementById('order-list');
            const emptyMsg = document.getElementById('empty-message');

            if (orders.length === 0) {
                emptyMsg.classList.remove('d-none');
                return;
            }

            orders.forEach(order => {
                let itemsHtml = '';
                order.orderItems.forEach(item => {
                    itemsHtml += `
                        <div class="d-flex align-items-center mb-3">
                            <img src="${item.thumbnailUrl || '/images/no-image.png'}" class="item-img me-3">
                            <div class="flex-grow-1">
                                <div class="fw-bold text-dark">${item.productName}</div>
                                <div class="text-muted small">${item.orderPrice.toLocaleString()}ì› Ã— ${item.count}ê°œ</div>
                            </div>
                        </div>
                    `;
                });

                let statusBadgeClass = 'bg-secondary';
                let actionButton = '';

                switch (order.status) {
                    case 'ORDER':
                        statusBadgeClass = 'bg-primary';
                        actionButton = `<button class="btn btn-sm btn-outline-danger fw-bold" onclick="cancelOrder(${order.orderId})">ì£¼ë¬¸ì·¨ì†Œ</button>`;
                        break;

                    case 'PREPARING':
                        statusBadgeClass = 'bg-warning text-dark';
                        actionButton = `<button class="btn btn-sm btn-outline-secondary" onclick="requestRefund(${order.orderId})">í™˜ë¶ˆìš”ì²­</button>`;
                        break;

                    case 'SHIPPING':
                        statusBadgeClass = 'bg-success';
                        actionButton = `<button class="btn btn-sm btn-outline-secondary" disabled>ë°°ì†¡ì¤‘</button>`;
                        break;

                    case 'COMPLETED':
                        statusBadgeClass = 'bg-dark';
                        actionButton = `<button class="btn btn-sm btn-outline-secondary" onclick="requestRefund(${order.orderId})">ë°˜í’ˆ/í™˜ë¶ˆì‹ ì²­</button>`;
                        break;

                    case 'CANCEL_REQUESTED':
                        statusBadgeClass = 'bg-info text-dark';
                        actionButton = `<button class="btn btn-sm btn-secondary" disabled>ì²˜ë¦¬ ëŒ€ê¸°ì¤‘</button>`;
                        break;

                    case 'CANCEL':
                        statusBadgeClass = 'bg-danger';
                        actionButton = '';
                        break;

                    default:
                        statusBadgeClass = 'bg-secondary';
                        actionButton = '';
                }

                let dateStr = order.orderDate.replace('T', ' ').substring(0, 16);
                const statusText = StatusMap[order.status] || order.status;

                const html = `
                    <div class="card mb-4 shadow-sm order-card status-${order.status}">
                        <div class="card-header d-flex justify-content-between align-items-center bg-white py-3">
                            <div class="d-flex align-items-center gap-2">
                                <span class="badge ${statusBadgeClass}">${statusText}</span>
                                <span class="fw-bold text-muted small">${dateStr}</span>
                            </div>
                            <div class="d-flex align-items-center gap-3">
                                <span class="fw-bold text-primary">ì´ ${order.totalPrice.toLocaleString()}ì›</span>
                                ${actionButton}
                            </div>
                        </div>
                        <div class="card-body">
                            ${itemsHtml}
                        </div>
                    </div>
                `;
                listContainer.insertAdjacentHTML('beforeend', html);
            });

        } catch (error) {
            console.error(error);
        }
    }

    async function cancelOrder(orderId) {
        if (!confirm('ì •ë§ ì£¼ë¬¸ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ì¦‰ì‹œ í™˜ë¶ˆë©ë‹ˆë‹¤)')) return;
        try {
            const response = await fetch(`/api/shop/order/${orderId}/cancel`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });

            if (response.ok) {
                alert('ì£¼ë¬¸ì´ ì •ìƒì ìœ¼ë¡œ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.');
                location.reload();
            } else {
                const errorText = await response.text();
                alert('ì·¨ì†Œ ì‹¤íŒ¨: ' + errorText);
            }
        } catch (e) {
            alert('ì˜¤ë¥˜ ë°œìƒ');
        }
    }

    async function requestRefund(orderId) {
        if (!confirm('í™˜ë¶ˆ/ë°˜í’ˆì„ ìš”ì²­í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nê´€ë¦¬ì í™•ì¸ í›„ ì²˜ë¦¬ë©ë‹ˆë‹¤.')) return;
        try {
            const response = await fetch(`/api/shop/order/${orderId}/refund`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });

            if (response.ok) {
                alert('í™˜ë¶ˆ ìš”ì²­ì´ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤.');
                location.reload();
            } else {
                const errorText = await response.text();
                alert('ìš”ì²­ ì‹¤íŒ¨: ' + errorText);
            }
        } catch (e) {
            alert('ì˜¤ë¥˜ ë°œìƒ');
        }
    }
</script>
</body>
</html>