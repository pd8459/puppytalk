<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>PuppyTalk - ì£¼ë¬¸ ë‚´ì—­</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .item-img { width: 60px; height: 60px; object-fit: cover; border-radius: 5px; }
        .order-card { border-left: 5px solid #0d6efd; }
        .order-card.CANCEL { border-left-color: #dc3545; background-color: #f8d7da; }
    </style>
</head>
<body>
<div th:replace="~{fragments/navbar :: navbar}"></div>

<div class="container mt-5 mb-5">
    <h2 class="mb-4">ğŸ“¦ ì£¼ë¬¸ ë‚´ì—­</h2>
    <div id="order-list"></div>
    <div id="empty-message" class="text-center py-5 d-none">
        <h4>ì£¼ë¬¸í•œ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</h4>
        <a href="/shop/list" class="btn btn-primary mt-3">ì‡¼í•‘í•˜ëŸ¬ ê°€ê¸°</a>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    window.addEventListener('DOMContentLoaded', loadOrders);

    async function loadOrders() {
        try {
            const response = await fetch('/api/shop/order/list');
            if (response.status === 401 || response.status === 403) {
                alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                location.href = '/login';
                return;
            }
            if (!response.ok) throw new Error('ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨');

            const orders = await response.json();
            const listContainer = document.getElementById('order-list');
            const emptyMsg = document.getElementById('empty-message');

            if (orders.length === 0) {
                emptyMsg.classList.remove('d-none');
                return;
            }

            orders.forEach(order => {
                let itemsHtml = '';
                order.orderItems.forEach(item => {
                    itemsHtml += `
                        <div class="d-flex align-items-center mb-2">
                            <img src="${item.thumbnailUrl || '/images/no-image.png'}" class="item-img me-3">
                            <div>
                                <div class="fw-bold">${item.productName}</div>
                                <div class="text-muted small">${item.orderPrice.toLocaleString()}ì› Ã— ${item.count}ê°œ</div>
                            </div>
                        </div>
                    `;
                });

                let statusBadge = order.status === 'ORDER'
                    ? '<span class="badge bg-success">ì£¼ë¬¸ì™„ë£Œ</span>'
                    : '<span class="badge bg-danger">ì·¨ì†Œë¨</span>';

                let cancelButton = order.status === 'ORDER'
                    ? `<button class="btn btn-sm btn-outline-danger" onclick="cancelOrder(${order.orderId})">ì£¼ë¬¸ì·¨ì†Œ</button>`
                    : '';

                const html = `
                    <div class="card mb-4 shadow-sm order-card ${order.status}">
                        <div class="card-header d-flex justify-content-between align-items-center bg-white">
                            <div>
                                <span class="fw-bold me-2">${order.orderDate}</span>
                                ${statusBadge}
                            </div>
                            <div>
                                <span class="fw-bold text-primary me-3">ì´ ${order.totalPrice.toLocaleString()}ì›</span>
                                ${cancelButton}
                            </div>
                        </div>
                        <div class="card-body">
                            ${itemsHtml}
                        </div>
                    </div>
                `;
                listContainer.insertAdjacentHTML('beforeend', html);
            });

        } catch (error) {
            console.error(error);
        }
    }

    async function cancelOrder(orderId) {
        if (!confirm('ì£¼ë¬¸ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
        try {
            const response = await fetch(`/api/shop/order/${orderId}/cancel`, { method: 'POST' });
            if (response.ok) {
                alert('ì£¼ë¬¸ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.');
                location.reload();
            } else {
                alert('ì·¨ì†Œ ì‹¤íŒ¨');
            }
        } catch (e) {
            alert('ì˜¤ë¥˜ ë°œìƒ');
        }
    }
</script>
</body>
</html>