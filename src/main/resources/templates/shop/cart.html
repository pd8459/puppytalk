<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>PuppyTalk - ì¥ë°”êµ¬ë‹ˆ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .cart-img {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 5px;
        }
        .quantity-input {
            width: 50px;
            text-align: center;
            border: 1px solid #ced4da;
            border-radius: 0;
        }
        .btn-qty {
            border: 1px solid #ced4da;
            background-color: #fff;
        }
    </style>
</head>
<body>
<div th:replace="~{fragments/navbar :: navbar}"></div>

<div class="container mt-5 mb-5">
    <h2 class="mb-4">ğŸ›’ ì¥ë°”êµ¬ë‹ˆ</h2>

    <div class="row">
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm">
                <div class="card-body p-0">
                    <table class="table table-hover mb-0 align-middle">
                        <thead class="table-light">
                        <tr>
                            <th scope="col" class="ps-4" style="width: 40%">ìƒí’ˆì •ë³´</th>
                            <th scope="col" style="width: 15%">ê°€ê²©</th>
                            <th scope="col" style="width: 20%">ìˆ˜ëŸ‰</th>
                            <th scope="col" style="width: 15%">í•©ê³„</th>
                            <th scope="col" style="width: 10%"></th>
                        </tr>
                        </thead>
                        <tbody id="cart-list">
                        </tbody>
                    </table>
                </div>
            </div>
            <div id="empty-message" class="text-center py-5 d-none">
                <h4>ì¥ë°”êµ¬ë‹ˆê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤ í……! ğŸ¶</h4>
                <a href="/shop/list" class="btn btn-primary mt-3">ì‡¼í•‘í•˜ëŸ¬ ê°€ê¸°</a>
            </div>
        </div>

        <div class="col-lg-4 mt-4 mt-lg-0">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <h5 class="card-title fw-bold mb-4">ì£¼ë¬¸ ì˜ˆìƒ ê¸ˆì•¡</h5>
                    <div class="d-flex justify-content-between mb-3">
                        <span>ì´ ìƒí’ˆê¸ˆì•¡</span>
                        <span id="total-price">0ì›</span>
                    </div>
                    <div class="d-flex justify-content-between mb-3">
                        <span>ë°°ì†¡ë¹„</span>
                        <span>0ì›</span>
                    </div>
                    <hr>
                    <div class="d-flex justify-content-between mb-4">
                        <strong class="fs-5">ì´ ê²°ì œê¸ˆì•¡</strong>
                        <strong class="fs-5 text-primary" id="final-price">0ì›</strong>
                    </div>
                    <button class="btn btn-primary w-100 py-2 fs-5 fw-bold" onclick="alert('ê²°ì œ ê¸°ëŠ¥ ì—°ë™ ì˜ˆì •ì…ë‹ˆë‹¤!')">êµ¬ë§¤í•˜ê¸°</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    window.addEventListener('DOMContentLoaded', loadCart);

    async function loadCart() {
        const listContainer = document.getElementById('cart-list');
        const emptyMessage = document.getElementById('empty-message');

        try {
            const response = await fetch('/api/shop/cart');

            if (response.status === 401 || response.status === 403) {
                alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                location.href = '/login';
                return;
            }
            if (!response.ok) throw new Error('ì¥ë°”êµ¬ë‹ˆë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');

            const data = await response.json();
            const items = data.cartItems || [];

            if (items.length === 0) {
                listContainer.innerHTML = '';
                emptyMessage.classList.remove('d-none');
                updateSummary(0);
                return;
            }

            emptyMessage.classList.add('d-none');
            let html = '';

            items.forEach(item => {
                const totalItemPrice = item.price * item.count;

                html += `
                    <tr>
                        <td class="ps-4">
                            <div class="d-flex align-items-center">
                                <img src="${item.thumbnailUrl || '/images/no-image.png'}" class="cart-img me-3"
                                     onerror="this.src='https://via.placeholder.com/80?text=Img'">
                                <div class="text-truncate" style="max-width: 200px;">
                                    <a href="/shop/detail?id=${item.cartItemId}" class="text-decoration-none text-dark fw-bold">${item.productName}</a>
                                </div>
                            </div>
                        </td>
                        <td>${item.price.toLocaleString()}ì›</td>
                        <td>
                            <div class="input-group input-group-sm" style="width: 100px;">
                                <button class="btn btn-qty" type="button" onclick="updateQty(${item.cartItemId}, ${item.count - 1})">-</button>
                                <input type="text" class="form-control quantity-input" value="${item.count}" readonly>
                                <button class="btn btn-qty" type="button" onclick="updateQty(${item.cartItemId}, ${item.count + 1})">+</button>
                            </div>
                        </td>
                        <td class="fw-bold">${totalItemPrice.toLocaleString()}ì›</td>
                        <td>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteItem(${item.cartItemId})">Ã—</button>
                        </td>
                    </tr>
                `;
            });

            listContainer.innerHTML = html;
            updateSummary(data.totalOrderPrice);

        } catch (error) {
            console.error(error);
            alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    }

    async function updateQty(cartItemId, newCount) {
        if (newCount < 1) return;

        try {
            const response = await fetch(`/api/shop/cart/${cartItemId}?count=${newCount}`, {
                method: 'PATCH'
            });

            if (response.ok) {
                loadCart();
            } else {
                alert('ìˆ˜ëŸ‰ ë³€ê²½ ì‹¤íŒ¨');
            }
        } catch (error) {
            console.error(error);
        }
    }

    async function deleteItem(cartItemId) {
        if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

        try {
            const response = await fetch(`/api/shop/cart/${cartItemId}`, {
                method: 'DELETE'
            });

            if (response.ok) {
                loadCart();
            } else {
                alert('ì‚­ì œ ì‹¤íŒ¨');
            }
        } catch (error) {
            console.error(error);
        }
    }

    function updateSummary(totalPrice) {
        const formatted = totalPrice.toLocaleString() + 'ì›';
        document.getElementById('total-price').textContent = formatted;
        document.getElementById('final-price').textContent = formatted;
    }
</script>
</body>
</html>