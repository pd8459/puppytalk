<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>PuppyTalk - ìƒí’ˆ ìƒì„¸</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .product-img {
            width: 100%;
            max-height: 500px;
            object-fit: contain;
            border-radius: 10px;
            background-color: #f8f9fa;
        }
        .badge-breed { background-color: #6f42c1; color: white; font-size: 0.9rem; }
        .badge-size { background-color: #fd7e14; color: white; font-size: 0.9rem; }
    </style>
</head>
<body>
<div th:replace="~{fragments/navbar :: navbar}"></div>

<div class="container mt-5 mb-5">
    <div id="product-container" style="display: none;">
        <div class="row">
            <div class="col-md-6 mb-4">
                <img id="p-image" src="" class="product-img border" alt="ìƒí’ˆ ì´ë¯¸ì§€">
            </div>

            <div class="col-md-6">
                <div class="mb-2">
                    <span id="p-breed" class="badge badge-breed me-1" style="display: none;"></span>
                    <span id="p-size" class="badge badge-size" style="display: none;"></span>
                </div>

                <h2 id="p-name" class="fw-bold mb-3"></h2>

                <div id="time-deal-box" class="alert alert-danger d-flex align-items-center mb-3" role="alert" style="display: none;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-alarm-fill me-2" viewBox="0 0 16 16">
                        <path d="M6 .5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v9a.5.5 0 0 1-.5.5H6a.5.5 0 0 1-.5-.5V.5zM3.802 1.571a.5.5 0 0 1 .634.197L5.5 3.32a.5.5 0 0 1-.228.68l-6 3.5a.5.5 0 0 1-.68-.23L.197 2.205a.5.5 0 0 1 .197-.634l3.408-1.999zM8.5 1.5v9h-1v-9h1zm5.5 2.053l-3.408 2a.5.5 0 0 1-.68-.23L8.5 3.32a.5.5 0 0 1 .634-.197l3.408 1.999a.5.5 0 0 1 .197.634l-.634 1.096a.5.5 0 0 1-.68.23l-3.408-2zM9.5 14.5V15h-3v-.5a.5.5 0 0 1 .5-.5h2a.5.5 0 0 1 .5.5zM12 5.5a4.5 4.5 0 1 1-9 0 4.5 4.5 0 0 1 9 0z"/>
                    </svg>
                    <div>
                        <strong>ë§ˆê° ì„ë°•!</strong> ë‚¨ì€ ì‹œê°„: <span id="countdown" class="fw-bold fs-5 ms-2">00:00:00</span>
                    </div>
                </div>

                <div id="price-area" class="mb-4"></div>

                <div class="mb-3">
                    <small class="text-muted">íŒë§¤ì: <span id="p-seller" class="fw-bold"></span></small>
                </div>
                <div class="mb-4">
                    <p class="text-muted">ë‚¨ì€ ìˆ˜ëŸ‰: <span id="p-stock"></span>ê°œ</p>
                </div>

                <div class="mb-4 row align-items-center">
                    <div class="col-auto">
                        <label for="quantity" class="col-form-label fw-bold">ìˆ˜ëŸ‰</label>
                    </div>
                    <div class="col-auto">
                        <input type="number" id="quantity" class="form-control" value="1" min="1" style="width: 80px;">
                    </div>
                </div>

                <hr>

                <div class="d-grid gap-2">
                    <button class="btn btn-primary btn-lg" onclick="alert('ì¥ë°”êµ¬ë‹ˆì— ë‹´ì•„ ê²°ì œí•´ì£¼ì„¸ìš”!')">ë°”ë¡œ êµ¬ë§¤í•˜ê¸°</button>
                    <button id="add-cart-btn" class="btn btn-outline-dark btn-lg">ì¥ë°”êµ¬ë‹ˆ ë‹´ê¸°</button>
                    <button id="chat-btn" class="btn btn-outline-success btn-lg">ğŸ’¬ íŒë§¤ìì—ê²Œ ë¬¸ì˜í•˜ê¸°</button>

                    <a th:href="@{/shop/update(id=${productId})}" class="btn btn-secondary mt-2">ğŸ› ï¸ ìƒí’ˆ ìˆ˜ì • (ê´€ë¦¬ììš©)</a>
                </div>
            </div>
        </div>

        <div class="row mt-5">
            <div class="col-12">
                <h4 class="border-bottom pb-2 mb-3">ìƒí’ˆ ìƒì„¸ ì„¤ëª…</h4>
                <div id="p-desc" class="p-3 bg-light rounded" style="white-space: pre-line; min-height: 200px;"></div>
            </div>
        </div>
    </div>

    <div id="loading" class="text-center py-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script th:inline="javascript">
    const productId = [[${productId}]];
    let currentStock = 0;
    let sellerUsername = "1111";

    window.addEventListener('DOMContentLoaded', async () => {
        try {
            const response = await fetch(`/api/shop/products/${productId}`);
            if (!response.ok) throw new Error('ìƒí’ˆ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');

            const p = await response.json();
            currentStock = p.stockQuantity;

            if (p.sellerUsername) {
                sellerUsername = p.sellerUsername;
            }

            document.getElementById('p-name').textContent = p.name;
            document.getElementById('p-stock').textContent = p.stockQuantity;
            document.getElementById('p-desc').textContent = p.description;
            document.getElementById('p-seller').textContent = p.sellerNickname || 'ê´€ë¦¬ì';
            document.getElementById('quantity').max = p.stockQuantity;

            const priceArea = document.getElementById('price-area');
            if (p.discountRate > 0) {
                priceArea.innerHTML = `
                    <div class="d-flex align-items-center">
                        <h3 class="text-muted text-decoration-line-through me-2 mb-0">${p.originalPrice.toLocaleString()}ì›</h3>
                        <h2 class="text-danger fw-bold mb-0">${p.price.toLocaleString()}ì›</h2>
                        <span class="badge bg-danger ms-2 fs-6">${p.discountRate}% OFF</span>
                    </div>
                `;
            } else {
                priceArea.innerHTML = `<h2 class="text-primary fw-bold">${p.price.toLocaleString()}ì›</h2>`;
            }

            if (p.saleEndTime) {
                const timerBox = document.getElementById('time-deal-box');
                const countdownSpan = document.getElementById('countdown');
                const endTime = new Date(p.saleEndTime).getTime();

                function updateTimer() {
                    const now = new Date().getTime();
                    const distance = endTime - now;

                    if (distance < 0) {
                        clearInterval(interval);
                        timerBox.classList.remove('alert-danger');
                        timerBox.classList.add('alert-secondary');
                        timerBox.innerHTML = "<strong>ğŸš« íƒ€ì„ë”œì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.</strong>";
                        timerBox.style.display = 'block';
                        return;
                    }

                    const h = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                    const m = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                    const s = Math.floor((distance % (1000 * 60)) / 1000);

                    countdownSpan.innerText =
                        `${h < 10 ? '0' + h : h}:${m < 10 ? '0' + m : m}:${s < 10 ? '0' + s : s}`;

                    timerBox.style.display = 'flex';
                }

                const interval = setInterval(updateTimer, 1000);
                updateTimer();
            }

            const imgEl = document.getElementById('p-image');
            imgEl.src = p.thumbnailUrl || '/images/no-image.png';
            imgEl.onerror = () => imgEl.src = 'https://via.placeholder.com/500?text=No+Image';

            if (p.targetBreed) {
                const breedBadge = document.getElementById('p-breed');
                breedBadge.textContent = p.targetBreed + ' ì¶”ì²œ';
                breedBadge.style.display = 'inline-block';
            }
            if (p.recommendedSize && p.recommendedSize !== 'ALL') {
                const sizeBadge = document.getElementById('p-size');
                sizeBadge.textContent = p.recommendedSize + 'ìš©';
                sizeBadge.style.display = 'inline-block';
            }

            document.getElementById('loading').style.display = 'none';
            document.getElementById('product-container').style.display = 'block';

            document.getElementById('chat-btn').onclick = async () => {
                try {
                    const response = await fetch(`/api/messages/inquiry/${sellerUsername}`, {
                        method: 'POST'
                    });

                    if (response.ok) {
                        const conversationId = await response.json();
                        window.location.href = `/inquiry?id=${conversationId}`;
                    } else {
                        const errorText = await response.text();
                        alert('ë¬¸ì˜ ì‹¤íŒ¨: ' + errorText);
                    }
                } catch (error) {
                    console.error(error);
                    alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            };
        } catch (error) {
            alert(error.message);
            location.href = '/shop/list';
        }
    });

    document.getElementById('add-cart-btn').addEventListener('click', async () => {
        const count = parseInt(document.getElementById('quantity').value);

        if (count <= 0) {
            alert('ìˆ˜ëŸ‰ì€ 1ê°œ ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
            return;
        }
        if (count > currentStock) {
            alert('ì¬ê³ ë³´ë‹¤ ë§ì´ ë‹´ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }

        try {
            const response = await fetch('/api/shop/cart', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    productId: productId,
                    count: count
                })
            });

            if (response.ok) {
                if (confirm('ì¥ë°”êµ¬ë‹ˆì— ë‹´ì•˜ìŠµë‹ˆë‹¤. ì¥ë°”êµ¬ë‹ˆë¡œ ì´ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                    window.location.href = '/shop/cart';
                }
            } else {
                if (response.status === 401 || response.status === 403) {
                    alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                    location.href = '/login';
                } else {
                    const errorText = await response.text();
                    alert('ì‹¤íŒ¨: ' + errorText);
                }
            }
        } catch (error) {
            console.error(error);
            alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    });
</script>
</body>
</html>