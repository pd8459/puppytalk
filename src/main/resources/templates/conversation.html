<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>PuppyTalk - 쪽지</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .chat-container { max-width: 800px; margin: auto; }
        .chat-box { height: 60vh; overflow-y: auto; padding: 1rem; border: 1px solid #ddd; border-radius: 8px; }
        .message { display: flex; align-items: flex-start; margin-bottom: 1rem; }
        .message p { max-width: 70%; padding: 0.5rem 1rem; border-radius: 15px; margin-bottom: 0.25rem; word-break: break-word; }
        .message.outgoing { justify-content: flex-end; }
        .message.outgoing p {
            background-color: #0d6efd;
            color: white;
            font-size: 1rem;
            line-height: 1.4rem;
            padding: 0.5rem 0.8rem;
            border-radius: 15px;
            display: inline-block;
            max-width: 100%;
            margin: 0;
        }

        .message.incoming p { background-color: #e9ecef; }
        .profile-img { width: 40px; height: 40px; object-fit: cover; border-radius: 50%; }
        #reply-content { height: 38px; line-height: 38px; resize: none; overflow-y: hidden; }
        .message.outgoing .profile-img { display: none; }
        .message.outgoing strong { display: none; }
        .message.outgoing small { text-align: right; display: block; }
    </style>
</head>
<body>
<div th:replace="~{fragments/navbar :: navbar}"></div>

<div class="container mt-4 chat-container">
    <div class="d-flex align-items-center mb-3">
        <a href="/messages" class="btn btn-light me-3">←</a>
        <h3 id="conversation-header" class="mb-0"></h3>
    </div>
    <div id="chat-box" class="chat-box bg-light"></div>
    <form id="reply-form" class="mt-3">
        <div class="input-group">
            <input type="text" id="reply-content" class="form-control" placeholder="메시지를 입력하세요..." required autocomplete="off">
            <button class="btn btn-primary" type="submit">답장</button>
        </div>
    </form>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const token = localStorage.getItem('jwt');
    const conversationId = new URLSearchParams(window.location.search).get('id');
    const chatBox = document.getElementById('chat-box');
    const header = document.getElementById('conversation-header');
    const replyForm = document.getElementById('reply-form');
    const replyContent = document.getElementById('reply-content');
    let otherUserUsername = '';
    let currentUserProfileImg = '/images/default_profile.png';
    let otherUserProfileImg = '/images/default_profile.png';
    let currentUsername = '';

    window.addEventListener('DOMContentLoaded', async () => {
        if (!token || !conversationId) {
            alert('잘못된 접근입니다.');
            window.location.href = '/main';
            return;
        }
        await loadMessages();
    });

    async function loadMessages() {
        try {
            const [messagesResponse, profileResponse] = await Promise.all([
                fetch(`/api/messages/${conversationId}`, { headers: { 'Authorization': 'Bearer ' + token } }),
                fetch('/api/profile', { headers: { 'Authorization': 'Bearer ' + token } })
            ]);

            if (!messagesResponse.ok) throw new Error('메시지를 불러오지 못했습니다.');
            const messages = await messagesResponse.json();

            if (profileResponse.ok) {
                const profile = await profileResponse.json();
                currentUsername = profile.username;
                if(profile.profileImageUrl) currentUserProfileImg = profile.profileImageUrl;
            }

            chatBox.innerHTML = '';

            if (messages.length > 0) {
                const firstMessage = messages[0];
                if (firstMessage.senderUsername === currentUsername) {
                    header.textContent = `${firstMessage.receiverNickname}님과의 대화`;
                    otherUserUsername = firstMessage.receiverUsername;
                    if(firstMessage.receiverProfileImageUrl) otherUserProfileImg = firstMessage.receiverProfileImageUrl;
                } else {
                    header.textContent = `${firstMessage.senderNickname}님과의 대화`;
                    otherUserUsername = firstMessage.senderUsername;
                    if(firstMessage.senderProfileImageUrl) otherUserProfileImg = firstMessage.senderProfileImageUrl;
                }
            } else {
                header.textContent = '대화 내용이 없습니다.';
            }

            messages.forEach(msg => {
                const messageWrapper = document.createElement('div');
                const isSentByMe = msg.senderUsername === currentUsername;
                messageWrapper.className = isSentByMe ? 'message outgoing' : 'message incoming';

                const profileImg = isSentByMe ? currentUserProfileImg : otherUserProfileImg;
                const timeString = new Date(msg.createdAt).toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });

                const bubbleHtml = isSentByMe
                    ? `
                        <div class="flex-grow-1 text-end">
                            <p class="ms-auto">${msg.content}</p>
                            <small class="text-muted">${timeString}</small>
                        </div>
                    `
                    : `
                        <img src="${profileImg}" alt="profile" class="profile-img me-2">
                        <div class="flex-grow-1">
                            <strong style="font-size: 0.9em;">${msg.senderNickname}</strong>
                            <p>${msg.content}</p>
                            <small class="text-muted">${timeString}</small>
                        </div>
                    `;

                messageWrapper.innerHTML = bubbleHtml;
                chatBox.appendChild(messageWrapper);
            });
            chatBox.scrollTop = chatBox.scrollHeight;
        } catch (error) {
            chatBox.innerHTML = `<p class="text-center text-danger">${error.message}</p>`;
        }
    }

    replyContent.addEventListener("input", () => {
        const value = replyContent.value.replace(/\n/g, "");
        let result = "";
        for (let i = 0; i < value.length; i++) {
            if (i > 0 && i % 34 === 0) result += "\n";
            result += value[i];
        }
        replyContent.value = result;
    });

    replyForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const content = replyContent.value;
        if (!content.trim() || !otherUserUsername) return;

        try {
            const response = await fetch(`/api/messages/${otherUserUsername}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
                body: JSON.stringify({ content: content })
            });
            if (response.ok) {
                replyContent.value = '';
                await loadMessages();
            } else {
                alert('메시지 전송에 실패했습니다.');
            }
        } catch (error) {
            alert('메시지 전송 중 오류가 발생했습니다.');
        }
    });
</script>
</body>
</html>
