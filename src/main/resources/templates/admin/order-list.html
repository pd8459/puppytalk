<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>PuppyTalk - ê´€ë¦¬ì ì£¼ë¬¸ ê´€ë¦¬</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .table th, .table td { vertical-align: middle; }
        .tr-cancel { opacity: 0.6; background-color: #f8f9fa; }
    </style>
</head>
<body>

<div th:replace="~{fragments/navbar :: navbar}"></div>

<div class="container mt-5 mb-5">

    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h3 class="d-inline me-2">ğŸ“¦ ì „ì²´ ì£¼ë¬¸ ê´€ë¦¬</h3>
            <a href="/admin" class="btn btn-outline-dark btn-sm ms-2">
                <i class="fas fa-arrow-left"></i> ëŒ€ì‹œë³´ë“œë¡œ
            </a>
        </div>

        <div class="d-flex gap-2">
            <button class="btn btn-warning btn-sm fw-bold text-white" onclick="bulkUpdate('PREPARING')">
                <i class="fas fa-box"></i> ì„ íƒ ì¤€ë¹„ì¤‘
            </button>
            <button class="btn btn-success btn-sm fw-bold" onclick="bulkUpdate('SHIPPING')">
                <i class="fas fa-truck"></i> ì„ íƒ ë°°ì†¡ì‹œì‘
            </button>
            <button class="btn btn-secondary btn-sm fw-bold" onclick="bulkUpdate('COMPLETED')">
                <i class="fas fa-check"></i> ì„ íƒ ë°°ì†¡ì™„ë£Œ
            </button>

            <select id="filter-status" class="form-select w-auto" onchange="filterOrders()">
                <option value="">ì „ì²´ ë³´ê¸°</option>
                <option value="PENDING">ê²°ì œëŒ€ê¸°</option>
                <option value="ORDER">ê²°ì œì™„ë£Œ</option>
                <option value="PREPARING">ìƒí’ˆì¤€ë¹„ì¤‘</option>
                <option value="SHIPPING">ë°°ì†¡ì¤‘</option>
                <option value="COMPLETED">ë°°ì†¡ì™„ë£Œ</option>
                <option value="CANCEL">ì£¼ë¬¸ì·¨ì†Œ</option>
            </select>
        </div>
    </div>

    <div class="card shadow-sm">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0 text-center align-middle">
                    <thead class="table-light">
                    <tr>
                        <th style="width: 50px;">
                            <input type="checkbox" id="check-all" class="form-check-input" onclick="toggleAll(this)">
                        </th>
                        <th>ì£¼ë¬¸ë²ˆí˜¸</th>
                        <th>ì£¼ë¬¸ì¼ì‹œ</th>
                        <th>ì£¼ë¬¸ì</th>
                        <th>ìƒí’ˆëª…</th>
                        <th>ê²°ì œê¸ˆì•¡</th>
                        <th>í˜„ì¬ìƒíƒœ</th>
                        <th>ìƒíƒœë³€ê²½</th>
                    </tr>
                    </thead>
                    <tbody id="order-list"></tbody>
                </table>
            </div>
        </div>
        <div class="card-footer bg-white border-0 py-3">
            <nav>
                <ul class="pagination justify-content-center mb-0" id="pagination"></ul>
            </nav>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const StatusMap = {
        'PENDING': 'ê²°ì œëŒ€ê¸°',
        'ORDER': 'ê²°ì œì™„ë£Œ',
        'PREPARING': 'ìƒí’ˆì¤€ë¹„ì¤‘',
        'SHIPPING': 'ë°°ì†¡ì¤‘',
        'COMPLETED': 'ë°°ì†¡ì™„ë£Œ',
        'CANCEL': 'ì£¼ë¬¸ì·¨ì†Œ'
    };

    let currentPage = 0;
    let currentFilter = '';

    window.addEventListener('DOMContentLoaded', () => loadAllOrders(0));

    function filterOrders() {
        currentFilter = document.getElementById('filter-status').value;
        loadAllOrders(0);
    }

    function toggleAll(source) {
        const checkboxes = document.querySelectorAll('.order-check:not(:disabled)');
        checkboxes.forEach(cb => cb.checked = source.checked);
    }

    async function loadAllOrders(page) {
        currentPage = page;
        const listContainer = document.getElementById('order-list');
        document.getElementById('check-all').checked = false;

        try {
            let url = `/admin/api/orders?page=${page}&size=10`;
            if (currentFilter) {
                url += `&status=${currentFilter}`;
            }

            const response = await fetch(url);
            if (!response.ok) throw new Error('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨');

            const data = await response.json();
            const orders = data.content;

            let html = '';
            if(orders.length === 0) {
                html = '<tr><td colspan="8" class="py-5 text-muted">ì£¼ë¬¸ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
            } else {
                orders.forEach(order => {
                    const currentStatus = order.status || 'PENDING';
                    const isCanceled = currentStatus === 'CANCEL';

                    let selectOptions = '';
                    Object.keys(StatusMap).forEach(key => {
                        const selected = currentStatus === key ? 'selected' : '';
                        selectOptions += `<option value="${key}" ${selected}>${StatusMap[key]}</option>`;
                    });

                    let badgeClass = 'bg-secondary';
                    if (currentStatus === 'ORDER') badgeClass = 'bg-success';
                    else if (currentStatus === 'PREPARING') badgeClass = 'bg-warning text-dark';
                    else if (currentStatus === 'SHIPPING') badgeClass = 'bg-primary';
                    else if (currentStatus === 'COMPLETED') badgeClass = 'bg-dark';
                    else if (currentStatus === 'CANCEL') badgeClass = 'bg-danger';

                    const rowClass = isCanceled ? 'tr-cancel text-muted' : '';

                    html += `
                        <tr class="${rowClass}">
                            <td>
                                <input type="checkbox" class="order-check form-check-input"
                                       value="${order.orderId}"
                                       ${isCanceled ? 'disabled' : ''}>
                            </td>
                            <td>${order.orderId}</td>
                            <td>${order.orderDate}</td>
                            <td>${order.buyerName || 'ì•Œìˆ˜ì—†ìŒ'}</td>
                            <td class="text-start text-truncate" style="max-width: 200px;">
                                ${isCanceled ? '<del>' + order.orderName + '</del>' : order.orderName}
                            </td>
                            <td class="fw-bold">${order.totalPrice.toLocaleString()}ì›</td>
                            <td><span class="badge ${badgeClass}">${StatusMap[currentStatus]}</span></td>
                            <td>
                                <select class="form-select form-select-sm"
                                        onchange="changeStatus(${order.orderId}, this.value)"
                                        ${isCanceled ? 'disabled' : ''}>
                                    ${selectOptions}
                                </select>
                            </td>
                        </tr>
                    `;
                });
            }
            listContainer.innerHTML = html;
            renderPagination(data);

        } catch (error) {
            console.error(error);
            listContainer.innerHTML = '<tr><td colspan="8" class="text-danger py-3">ë°ì´í„° ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ</td></tr>';
        }
    }

    function renderPagination(pageData) {
        const pagination = document.getElementById('pagination');
        let html = '';

        if (!pageData.first) {
            html += `<li class="page-item"><button class="page-link" onclick="loadAllOrders(${pageData.number - 1})">ì´ì „</button></li>`;
        }

        for (let i = 0; i < pageData.totalPages; i++) {
            const active = i === pageData.number ? 'active' : '';
            html += `<li class="page-item ${active}"><button class="page-link" onclick="loadAllOrders(${i})">${i + 1}</button></li>`;
        }

        if (!pageData.last) {
            html += `<li class="page-item"><button class="page-link" onclick="loadAllOrders(${pageData.number + 1})">ë‹¤ìŒ</button></li>`;
        }

        pagination.innerHTML = html;
    }

    async function changeStatus(orderId, newStatus) {
        if (!confirm(`ì£¼ë¬¸ ìƒíƒœë¥¼ [${StatusMap[newStatus]}]ë¡œ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
            loadAllOrders(currentPage);
            return;
        }

        try {
            const response = await fetch(`/admin/api/orders/${orderId}/status?status=${newStatus}`, {
                method: 'PATCH'
            });

            if (response.ok) {
                alert('ìƒíƒœê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.');
                loadAllOrders(currentPage);
            } else {
                alert('ìƒíƒœ ë³€ê²½ ì‹¤íŒ¨');
                loadAllOrders(currentPage);
            }
        } catch (error) {
            alert('ì„œë²„ í†µì‹  ì˜¤ë¥˜');
            loadAllOrders(currentPage);
        }
    }

    async function bulkUpdate(newStatus) {
        const checkboxes = document.querySelectorAll('.order-check:checked:not(:disabled)');

        if (checkboxes.length === 0) {
            alert("ë³€ê²½í•  ì£¼ë¬¸ì„ ì„ íƒí•´ì£¼ì„¸ìš”. (ì·¨ì†Œëœ ì£¼ë¬¸ì€ ì„ íƒ ë¶ˆê°€)");
            return;
        }

        const orderIds = Array.from(checkboxes).map(cb => parseInt(cb.value));
        const statusName = StatusMap[newStatus];

        if (!confirm(`ì„ íƒí•œ ${orderIds.length}ê±´ì„ [${statusName}] ìƒíƒœë¡œ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

        try {
            const response = await fetch('/admin/api/orders/bulk-status', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    orderIds: orderIds,
                    status: newStatus
                })
            });

            if (response.ok) {
                const msg = await response.text();
                alert(msg);
                loadAllOrders(currentPage);
            } else {
                const errorMsg = await response.text();
                alert("ì¼ê´„ ë³€ê²½ ì‹¤íŒ¨: " + errorMsg);
            }
        } catch (error) {
            console.error(error);
            alert("ì„œë²„ í†µì‹  ì˜¤ë¥˜");
        }
    }
</script>
</body>
</html>