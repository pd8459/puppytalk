<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>PuppyTalk - CS ë¬¸ì˜ ê´€ë¦¬</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<div th:replace="~{fragments/navbar :: navbar}"></div>

<div class="container mt-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>ğŸ§ ê³ ê° ë¬¸ì˜ ê´€ë¦¬ (CS)</h2>
        <a href="/admin" class="btn btn-outline-secondary">â† ëŒ€ì‹œë³´ë“œë¡œ</a>
    </div>

    <div class="card shadow-sm">
        <div class="card-body p-0">
            <table class="table table-hover mb-0 align-middle">
                <thead class="table-light">
                <tr>
                    <th class="ps-4">ê³ ê°ëª…</th>
                    <th>ìµœê·¼ ë©”ì‹œì§€</th>
                    <th>ë¬¸ì˜ ì‹œê°„</th>
                    <th>ê´€ë¦¬</th>
                </tr>
                </thead>
                <tbody id="inquiry-list"></tbody>
            </table>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    window.addEventListener('DOMContentLoaded', async () => {
        try {
            // 1. ê´€ë¦¬ìì˜ ëª¨ë“  ëŒ€í™”ë°© ì¡°íšŒ
            const response = await fetch('/api/messages');
            const conversations = await response.json();
            const listContainer = document.getElementById('inquiry-list');

            if (conversations.length === 0) {
                listContainer.innerHTML = '<tr><td colspan="4" class="text-center py-4">ë¬¸ì˜ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                return;
            }

            let html = '';
            conversations.forEach(convo => {
                const lastMsg = convo.lastMessage ? convo.lastMessage : '(ë‚´ìš© ì—†ìŒ)';
                const time = convo.lastMessageCreatedAt ? new Date(convo.lastMessageCreatedAt).toLocaleString() : '-';

                // 2. ì±„íŒ…ë°© ë§í¬ ìƒì„± (ìƒëŒ€ë°© ID í¬í•¨)
                const link = `/inquiry?id=${convo.conversationId}&target=${convo.otherParticipantUsername}`;

                html += `
                    <tr>
                        <td class="ps-4 fw-bold">${convo.otherParticipantNickname}</td>
                        <td class="text-truncate" style="max-width: 300px;">${lastMsg}</td>
                        <td><small class="text-muted">${time}</small></td>
                        <td><a href="${link}" class="btn btn-sm btn-primary">ë‹µë³€í•˜ê¸°</a></td>
                    </tr>
                `;
            });
            listContainer.innerHTML = html;
        } catch (e) { console.error(e); }
    });
</script>
</body>
</html>