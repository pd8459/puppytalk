<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>PuppyTalk - ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
<div th:replace="~{fragments/navbar :: navbar}"></div>

<div class="container mt-5 mb-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="d-inline me-2">ğŸ‘‘ ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</h2>
            <span class="badge bg-dark">ADMIN MODE</span>
        </div>
        <div>
            <a href="/admin/inquiries" class="btn btn-success me-2">ğŸ§ CS ë¬¸ì˜</a>
            <a href="/admin/users" class="btn btn-dark me-2">ğŸ‘¥ íšŒì› ê´€ë¦¬</a>
            <a href="/admin/products" class="btn btn-primary me-2">ğŸ“¦ ìƒí’ˆ ê´€ë¦¬</a>
            <a href="/admin/orders" class="btn btn-warning me-2 fw-bold">ğŸšš ì£¼ë¬¸/ë°°ì†¡ ê´€ë¦¬</a>
            <a href="/admin/cancels" class="btn btn-danger fw-bold">â†©ï¸ ì·¨ì†Œ/ë°˜í’ˆ ê´€ë¦¬</a>
        </div>
    </div>

    <div class="row mb-5 g-3">
        <div class="col-md-3">
            <div class="card text-white bg-primary h-100 shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-title mb-0 opacity-75">ì´ ë§¤ì¶œì•¡</h6>
                            <h3 class="mt-2 fw-bold" id="stat-sales">0ì›</h3>
                        </div>
                        <i class="fas fa-won-sign fa-2x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-success h-100 shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-title mb-0 opacity-75">ì´ ì£¼ë¬¸ ìˆ˜</h6>
                            <h3 class="mt-2 fw-bold" id="stat-orders">0ê±´</h3>
                        </div>
                        <i class="fas fa-shopping-cart fa-2x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-warning h-100 shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-title mb-0 opacity-75 text-dark">ì´ íšŒì› ìˆ˜</h6>
                            <h3 class="mt-2 fw-bold text-dark" id="stat-members">0ëª…</h3>
                        </div>
                        <i class="fas fa-users fa-2x opacity-50 text-dark"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-danger h-100 shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-title mb-0 opacity-75">ì·¨ì†Œ/í™˜ë¶ˆ</h6>
                            <h3 class="mt-2 fw-bold" id="stat-cancels">0ê±´</h3>
                        </div>
                        <i class="fas fa-undo fa-2x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="mb-0">ğŸ“¦ ìµœê·¼ ì£¼ë¬¸ í˜„í™©</h4>
        <div class="d-flex align-items-center">
            <label for="filter-status" class="me-2 fw-bold">ìƒíƒœ í•„í„°:</label>
            <select id="filter-status" class="form-select w-auto" onchange="filterOrders()">
                <option value="">ì „ì²´ ë³´ê¸°</option>
                <option value="ORDER">ê²°ì œì™„ë£Œ</option>
                <option value="PREPARING">ìƒí’ˆì¤€ë¹„ì¤‘</option>
                <option value="SHIPPING">ë°°ì†¡ì¤‘</option>
                <option value="COMPLETED">ë°°ì†¡ì™„ë£Œ</option>
                <option value="CANCEL">ì£¼ë¬¸ì·¨ì†Œ</option>
            </select>
        </div>
    </div>

    <div class="card shadow-sm">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0 align-middle text-center">
                    <thead class="table-light">
                    <tr>
                        <th>ì£¼ë¬¸ë²ˆí˜¸</th>
                        <th>ì£¼ë¬¸ì¼ì‹œ</th>
                        <th>ì£¼ë¬¸ì</th>
                        <th>ìƒí’ˆì •ë³´</th>
                        <th>ê²°ì œê¸ˆì•¡</th>
                        <th>í˜„ì¬ìƒíƒœ</th>
                        <th>ìƒíƒœë³€ê²½</th>
                    </tr>
                    </thead>
                    <tbody id="order-list"></tbody>
                </table>
            </div>
        </div>
        <div class="card-footer bg-white border-0 py-3">
            <nav>
                <ul class="pagination justify-content-center mb-0" id="pagination"></ul>
            </nav>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const StatusMap = {
        'PENDING': 'ê²°ì œëŒ€ê¸°',
        'ORDER': 'ê²°ì œì™„ë£Œ',
        'PREPARING': 'ìƒí’ˆì¤€ë¹„ì¤‘',
        'SHIPPING': 'ë°°ì†¡ì¤‘',
        'COMPLETED': 'ë°°ì†¡ì™„ë£Œ',
        'CANCEL': 'ì£¼ë¬¸ì·¨ì†Œ',
        'CANCEL_REQUESTED': 'í™˜ë¶ˆìš”ì²­ì¤‘'
    };

    let currentPage = 0;
    let currentFilter = '';

    window.addEventListener('DOMContentLoaded', async () => {
        await loadStats();
        await loadAllOrders(0);
    });

    async function loadStats() {
        try {
            const response = await fetch('/admin/api/stats');
            if (response.status === 403) {
                alert('ê´€ë¦¬ì ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.');
                location.href = '/main';
                return;
            }
            const stats = await response.json();

            document.getElementById('stat-sales').textContent = stats.totalSales.toLocaleString() + 'ì›';
            document.getElementById('stat-orders').textContent = stats.totalOrders + 'ê±´';
            document.getElementById('stat-members').textContent = stats.totalMembers + 'ëª…';
            document.getElementById('stat-cancels').textContent = (stats.totalCancels || 0) + 'ê±´';

        } catch (error) {
            console.error(error);
        }
    }

    function filterOrders() {
        currentFilter = document.getElementById('filter-status').value;
        loadAllOrders(0);
    }

    async function loadAllOrders(page) {
        currentPage = page;
        const listContainer = document.getElementById('order-list');

        try {
            let url = `/admin/api/orders?page=${page}&size=10`;
            if (currentFilter) {
                url += `&status=${currentFilter}`;
            }

            const response = await fetch(url);
            const data = await response.json();
            const orders = data.content;

            let html = '';
            if(orders.length === 0) {
                html = '<tr><td colspan="7" class="py-5 text-muted">ì£¼ë¬¸ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
            } else {
                orders.forEach(order => {
                    const itemName = order.orderName || 'ìƒí’ˆ ì •ë³´ ì—†ìŒ';

                    let selectOptions = '';
                    Object.keys(StatusMap).forEach(key => {
                        const selected = order.status === key ? 'selected' : '';
                        const disabled = order.status === 'CANCEL' ? 'disabled' : '';
                        selectOptions += `<option value="${key}" ${selected} ${disabled}>${StatusMap[key]}</option>`;
                    });

                    const rowClass = order.status === 'CANCEL' ? 'opacity-50 bg-light' : '';
                    const badgeClass = order.status === 'CANCEL' ? 'bg-danger' :
                        order.status === 'CANCEL_REQUESTED' ? 'bg-warning text-dark' : 'bg-secondary';

                    html += `
                        <tr class="${rowClass}">
                            <td>${order.orderId}</td>
                            <td>${order.orderDate}</td>
                            <td>${order.buyerName}</td>
                            <td class="text-start text-truncate" style="max-width: 200px;">${itemName}</td>
                            <td class="fw-bold">${order.totalPrice.toLocaleString()}ì›</td>
                            <td><span class="badge ${badgeClass}">${StatusMap[order.status]}</span></td>
                            <td>
                                <select class="form-select form-select-sm"
                                        onchange="changeStatus(${order.orderId}, this.value)"
                                        ${order.status === 'CANCEL' ? 'disabled' : ''}>
                                    ${selectOptions}
                                </select>
                            </td>
                        </tr>
                    `;
                });
            }
            listContainer.innerHTML = html;
            renderPagination(data);

        } catch (error) {
            console.error(error);
        }
    }

    function renderPagination(pageData) {
        const pagination = document.getElementById('pagination');
        let html = '';

        if (!pageData.first) {
            html += `<li class="page-item"><button class="page-link" onclick="loadAllOrders(${pageData.number - 1})">ì´ì „</button></li>`;
        }

        for (let i = 0; i < pageData.totalPages; i++) {
            const active = i === pageData.number ? 'active' : '';
            html += `<li class="page-item ${active}"><button class="page-link" onclick="loadAllOrders(${i})">${i + 1}</button></li>`;
        }

        if (!pageData.last) {
            html += `<li class="page-item"><button class="page-link" onclick="loadAllOrders(${pageData.number + 1})">ë‹¤ìŒ</button></li>`;
        }

        pagination.innerHTML = html;
    }

    async function changeStatus(orderId, newStatus) {
        if (!confirm(`ì£¼ë¬¸ ìƒíƒœë¥¼ [${StatusMap[newStatus]}]ë¡œ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
            loadAllOrders(currentPage);
            return;
        }

        try {
            const response = await fetch(`/admin/api/orders/${orderId}/status?status=${newStatus}`, {
                method: 'PATCH'
            });

            if (response.ok) {
                alert('ìƒíƒœê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.');
                loadAllOrders(currentPage);
            } else {
                alert('ìƒíƒœ ë³€ê²½ ì‹¤íŒ¨');
                loadAllOrders(currentPage);
            }
        } catch (error) {
            alert('ì˜¤ë¥˜ ë°œìƒ');
            loadAllOrders(currentPage);
        }
    }
</script>
</body>
</html>