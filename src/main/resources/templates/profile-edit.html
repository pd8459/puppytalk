<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>PuppyTalk - 프로필 수정</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<div th:replace="~{fragments/navbar :: navbar}"></div>

<div class="container mt-4">
    <div class="card" style="max-width: 600px; margin: auto;">
        <div class="card-body">
            <h5 class="card-title mb-4">프로필 수정</h5>
            <form id="profile-edit-form">
                <div class="mb-3 text-center">
                    <img id="profile-image-preview" th:src="@{/images/default_profile.png}"
                         class="rounded-circle mb-2" alt="프로필 사진" width="150" height="150" style="object-fit: cover;">
                    <div>
                        <label for="profile-image-input" class="btn btn-secondary btn-sm">사진 선택</label>
                        <input type="file" class="d-none" id="profile-image-input" accept="image/*">
                    </div>
                </div>
                <div class="mb-3">
                    <label for="username" class="form-label">아이디</label>
                    <input type="text" class="form-control" id="username" readonly>
                    <div class="form-text">아이디는 변경할 수 없습니다.</div>
                </div>
                <div class="mb-3">
                    <label for="nickname" class="form-label">닉네임</label>
                    <input type="text" class="form-control" id="nickname" required>
                </div>
                <button type="submit" class="btn btn-primary">저장하기</button>
                <a href="/mypage" class="btn btn-secondary">취소</a>
            </form>
            <div id="message-div" class="mt-3"></div>

            <hr class="my-4">

            <div>
                <p>
                    <button class="btn btn-outline-danger" type="button" data-bs-toggle="collapse" data-bs-target="#password-change-collapse">
                        비밀번호 변경
                    </button>
                </p>
                <div class="collapse" id="password-change-collapse">
                    <div class="card card-body">
                        <form id="password-change-form">
                            <div class="mb-3">
                                <label for="current-password" class="form-label">현재 비밀번호</label>
                                <input type="password" class="form-control" id="current-password" required>
                            </div>
                            <div class="mb-3">
                                <label for="new-password" class="form-label">새 비밀번호</label>
                                <input type="password" class="form-control" id="new-password" required>
                            </div>
                            <div class="mb-3">
                                <label for="confirm-password" class="form-label">새 비밀번호 확인</label>
                                <input type="password" class="form-control" id="confirm-password" required>
                            </div>
                            <button type="submit" class="btn btn-danger">비밀번호 변경하기</button>
                        </form>
                        <div id="password-message-div" class="mt-3"></div>
                    </div>
                </div>
            </div>

            <hr class="my-4">
            <div class="text-end">
                <button id="delete-account-btn" class="btn btn-link text-danger">회원 탈퇴</button>
            </div>

        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const token = localStorage.getItem('jwt');
    const imageInput = document.getElementById('profile-image-input');
    const imagePreview = document.getElementById('profile-image-preview');

    document.addEventListener('DOMContentLoaded', async () => {
        if (!token) {
            alert('로그인이 필요합니다.');
            window.location.href = '/login';
            return;
        }
        try {
            const response = await fetch('/api/profile', {
                headers: { 'Authorization': 'Bearer ' + token }
            });
            if (!response.ok) throw new Error('프로필 정보를 불러오는데 실패했습니다.');
            const user = await response.json();

            if (user.profileImageUrl) {
                imagePreview.src = user.profileImageUrl;
            }
            document.getElementById('username').value = user.username;
            document.getElementById('nickname').value = user.nickname;
        } catch (error) {
            alert(error.message);
            window.location.href = '/main';
        }
    });

    imageInput.addEventListener('change', async (event) => {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (e) => { imagePreview.src = e.target.result; };
        reader.readAsDataURL(file);

        const formData = new FormData();
        formData.append('image', file);

        try {
            const response = await fetch('/api/profile/image', {
                method: 'POST',
                headers: { 'Authorization': 'Bearer ' + token },
                body: formData
            });
            if (!response.ok) throw new Error('이미지 업로드 실패');
            alert('프로필 사진이 변경되었습니다.');
        } catch (error) {
            alert(error.message);
        }
    });

    document.getElementById('profile-edit-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const newNickname = document.getElementById('nickname').value;
        const messageDiv = document.getElementById('message-div');
        try {
            const response = await fetch('/api/profile', {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + token
                },
                body: JSON.stringify({ nickname: newNickname })
            });
            if (response.ok) {
                alert('닉네임이 성공적으로 수정되었습니다.');
                window.location.href = '/mypage';
            } else {
                const errorData = await response.json();
                messageDiv.innerHTML = `<div class="alert alert-danger">${errorData.message}</div>`;
            }
        } catch (error) {
            messageDiv.innerHTML = `<div class="alert alert-danger">오류가 발생했습니다.</div>`;
        }
    });

    document.getElementById('password-change-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const currentPassword = document.getElementById('current-password').value;
        const newPassword = document.getElementById('new-password').value;
        const confirmPassword = document.getElementById('confirm-password').value;
        const messageDiv = document.getElementById('password-message-div');
        messageDiv.innerHTML = '';

        if (newPassword !== confirmPassword) {
            messageDiv.innerHTML = `<div class="alert alert-danger">새 비밀번호가 일치하지 않습니다.</div>`;
            return;
        }

        try {
            const response = await fetch('/api/profile/password', {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + token
                },
                body: JSON.stringify({ currentPassword, newPassword, confirmPassword })
            });

            if (response.ok) {
                alert('비밀번호가 성공적으로 변경되었습니다. 보안을 위해 다시 로그인해주세요.');
                localStorage.removeItem('jwt');
                window.location.href = '/login';
            } else {
                const errorText = await response.text();
                messageDiv.innerHTML = `<div class="alert alert-danger">${errorText}</div>`;
            }
        } catch (error) {
            messageDiv.innerHTML = `<div class="alert alert-danger">오류가 발생했습니다.</div>`;
        }
    });

    document.getElementById('delete-account-btn').addEventListener('click', async () => {
        if (!confirm('정말로 회원 탈퇴를 진행하시겠습니까? 계정은 복구할 수 없습니다.')) {
            return;
        }

        const password = prompt('본인 확인을 위해 현재 비밀번호를 입력해주세요.');
        if (!password) {
            alert('비밀번호가 입력되지 않아 취소되었습니다.');
            return;
        }

        const messageDiv = document.getElementById('message-div');
        messageDiv.innerHTML = '';

        try {
            const response = await fetch('/api/profile', {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + token
                },
                body: JSON.stringify({ password: password })
            });

            if (response.ok) {
                alert('회원 탈퇴가 완료되었습니다. 이용해주셔서 감사합니다.');
                localStorage.removeItem('jwt');
                window.location.href = '/main';
            } else {
                const errorText = await response.text();
                messageDiv.innerHTML = `<div class="alert alert-danger">${errorText}</div>`;
            }
        } catch (error) {
            messageDiv.innerHTML = `<div class="alert alert-danger">오류가 발생했습니다.</div>`;
        }
    });
</script>
</body>
</html>