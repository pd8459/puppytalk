<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>PuppyTalk - 프로필 수정</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<div th:replace="~{fragments/navbar :: navbar}"></div>

<div class="container my-4">
    <div class="card" style="max-width: 600px; margin: auto;">
        <div class="card-body">
            <h5 class="card-title mb-4">프로필 수정</h5>
            <form id="profile-edit-form">
                <div class="mb-3 text-center">
                    <img id="profile-image-preview" th:src="@{/images/default_profile.png}"
                         class="rounded-circle mb-2" alt="프로필 사진" width="150" height="150" style="object-fit: cover;">
                    <div>
                        <label for="profile-image-input" class="btn btn-secondary btn-sm">사진 선택</label>
                        <input type="file" class="d-none" id="profile-image-input" accept="image/*">
                    </div>
                </div>
                <div class="mb-3">
                    <label for="username" class="form-label">아이디</label>
                    <input type="text" class="form-control" id="username" readonly>
                    <div class="form-text">아이디는 변경할 수 없습니다.</div>
                </div>
                <div class="mb-3">
                    <label for="nickname" class="form-label">닉네임</label>
                    <input type="text" class="form-control" id="nickname" required>
                </div>
                <button type="submit" class="btn btn-primary">저장하기</button>
                <a href="/mypage" class="btn btn-secondary">취소</a>
            </form>
            <div id="message-div" class="mt-3"></div>

            <hr class="my-4">

            <div>
                <p>
                    <button class="btn btn-outline-danger" type="button" data-bs-toggle="collapse" data-bs-target="#password-change-collapse">
                        비밀번호 변경
                    </button>
                </p>
                <div class="collapse" id="password-change-collapse">
                    <div class="card card-body">
                        <form id="password-change-form">
                            <div class="mb-3">
                                <label for="current-password" class="form-label">현재 비밀번호</label>
                                <input type="password" class="form-control" id="current-password" required>
                            </div>
                            <div class="mb-3">
                                <label for="new-password" class="form-label">새 비밀번호</label>
                                <input type="password" class="form-control" id="new-password" required>
                            </div>
                            <div class="mb-3">
                                <label for="confirm-password" class="form-label">새 비밀번호 확인</label>
                                <input type="password" class="form-control" id="confirm-password" required>
                            </div>
                            <button type="submit" class="btn btn-danger">비밀번호 변경하기</button>
                        </form>
                        <div id="password-message-div" class="mt-3"></div>
                    </div>
                </div>
            </div>

            <hr class="my-4">

            <div id="pet-management-section">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="card-title mb-0">반려견 프로필 관리</h5>
                    <button id="add-pet-btn" class="btn btn-primary btn-sm">새 반려견 등록</button>
                </div>
                <div id="pet-list-container"></div>
            </div>

            <hr class="my-4">

            <div class="text-end">
                <button id="delete-account-btn" class="btn btn-link text-danger">회원 탈퇴</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="petModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="petModalLabel">새 반려견 등록</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="pet-form">
                    <input type="hidden" id="pet-id">
                    <div class="mb-3 text-center">
                        <img id="pet-image-preview" th:src="@{/images/default_pet_profile.png}"
                             class="rounded-circle mb-2" alt="반려견 프로필 사진" width="120" height="120" style="object-fit: cover;">
                        <div>
                            <label for="pet-image-input" class="btn btn-outline-secondary btn-sm">사진 선택</label>
                            <input type="file" class="d-none" id="pet-image-input" accept="image/*">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="pet-name" class="form-label">이름</label>
                        <input type="text" class="form-control" id="pet-name" required>
                    </div>
                    <div class="mb-3">
                        <label for="pet-breed" class="form-label">품종</label>
                        <input type="text" class="form-control" id="pet-breed" required>
                    </div>
                    <div class="mb-3">
                        <label for="pet-age" class="form-label">나이</label>
                        <input type="number" class="form-control" id="pet-age">
                    </div>
                    <div class="mb-3">
                        <label for="pet-gender" class="form-label">성별</label>
                        <select class="form-select" id="pet-gender">
                            <option value="MALE">수컷</option>
                            <option value="FEMALE">암컷</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="pet-introduction" class="form-label">한 줄 소개</label>
                        <textarea class="form-control" id="pet-introduction" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                <button type="button" class="btn btn-primary" id="save-pet-btn">저장</button>
            </div>
        </div>
    </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const imageInput = document.getElementById('profile-image-input');
    const imagePreview = document.getElementById('profile-image-preview');

    document.addEventListener('DOMContentLoaded', async () => {
        const petModal = new bootstrap.Modal(document.getElementById('petModal'));

        try {
            const response = await fetch('/api/profile');
            if (!response.ok) {
                if (response.status === 401 || response.status === 403) {
                    alert('로그인이 필요합니다.');
                    window.location.href = '/login';
                }
                throw new Error('프로필 정보를 불러오는데 실패했습니다.');
            }
            const user = await response.json();
            if (user.profileImageUrl) {
                imagePreview.src = user.profileImageUrl;
            }
            document.getElementById('username').value = user.username;
            document.getElementById('nickname').value = user.nickname;
        } catch (error) {
            console.error(error.message);
        }

        await loadUserPets(petModal);

        imageInput.addEventListener('change', uploadProfileImage);
        document.getElementById('profile-edit-form').addEventListener('submit', updateUserNickname);
        document.getElementById('password-change-form').addEventListener('submit', changePassword);
        document.getElementById('delete-account-btn').addEventListener('click', deleteAccount);

        document.getElementById('add-pet-btn').addEventListener('click', () => openPetModal(petModal));
        document.getElementById('save-pet-btn').addEventListener('click', () => handlePetFormSubmit(petModal));
        document.getElementById('pet-image-input').addEventListener('change', previewPetImage);
    });

    async function uploadProfileImage(event) {
        const file = event.target.files[0];
        if (!file) return;
        imagePreview.src = URL.createObjectURL(file);
        const formData = new FormData();
        formData.append('image', file);
        try {
            const response = await fetch('/api/profile/image', {
                method: 'POST',
                body: formData
            });
            if (!response.ok) throw new Error('이미지 업로드 실패');
            alert('프로필 사진이 변경되었습니다.');
        } catch (error) {
            alert(error.message);
        }
    }

    async function updateUserNickname(e) {
        e.preventDefault();
        const newNickname = document.getElementById('nickname').value;
        const messageDiv = document.getElementById('message-div');
        try {
            const response = await fetch('/api/profile', {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ nickname: newNickname })
            });
            if (response.ok) {
                alert('닉네임이 성공적으로 수정되었습니다.');
                window.location.href = '/mypage';
            } else {
                const errorData = await response.json();
                messageDiv.innerHTML = `<div class="alert alert-danger">${errorData.message}</div>`;
            }
        } catch (error) {
            messageDiv.innerHTML = `<div class="alert alert-danger">오류가 발생했습니다.</div>`;
        }
    }

    async function changePassword(e) {
        e.preventDefault();
        const currentPassword = document.getElementById('current-password').value;
        const newPassword = document.getElementById('new-password').value;
        const confirmPassword = document.getElementById('confirm-password').value;
        const messageDiv = document.getElementById('password-message-div');
        messageDiv.innerHTML = '';
        if (newPassword !== confirmPassword) {
            messageDiv.innerHTML = `<div class="alert alert-danger">새 비밀번호가 일치하지 않습니다.</div>`;
            return;
        }
        try {
            const response = await fetch('/api/profile/password', {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ currentPassword, newPassword, confirmPassword })
            });

            if (response.ok) {
                alert('비밀번호가 성공적으로 변경되었습니다. 보안을 위해 다시 로그인해주세요.');
                await fetch('/api/logout', { method: 'POST' });
                window.location.href = '/login';
            } else {
                const errorText = await response.text();
                messageDiv.innerHTML = `<div class="alert alert-danger">${errorText}</div>`;
            }
        } catch (error) {
            messageDiv.innerHTML = `<div class="alert alert-danger">오류가 발생했습니다.</div>`;
        }
    }

    async function deleteAccount() {
        if (!confirm('정말로 회원 탈퇴를 진행하시겠습니까? 계정은 복구할 수 없습니다.')) return;
        const password = prompt('본인 확인을 위해 현재 비밀번호를 입력해주세요.');
        if (!password) {
            alert('비밀번호가 입력되지 않아 취소되었습니다.');
            return;
        }
        const messageDiv = document.getElementById('message-div');
        try {
            const response = await fetch('/api/profile', {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ password: password })
            });
            if (response.ok) {
                alert('회원 탈퇴가 완료되었습니다. 이용해주셔서 감사합니다.');
                await fetch('/api/logout', { method: 'POST' });
                window.location.href = '/main';
            } else {
                const errorText = await response.text();
                messageDiv.innerHTML = `<div class="alert alert-danger">${errorText}</div>`;
            }
        } catch (error) {
            messageDiv.innerHTML = `<div class="alert alert-danger">오류가 발생했습니다.</div>`;
        }
    }

    async function loadUserPets(petModal) {
        try {
            const response = await fetch('/api/pets');
            if (!response.ok) throw new Error('반려견 정보를 불러오는 데 실패했습니다.');
            const pets = await response.json();
            const container = document.getElementById('pet-list-container');
            container.innerHTML = '';
            if (pets.length === 0) {
                container.innerHTML = '<p class="text-muted small">등록된 반려견이 없습니다.</p>';
                return;
            }
            pets.forEach(pet => {
                const petImage = pet.profileImageUrl || '/images/default_pet_profile.png';
                const card = document.createElement('div');
                card.className = 'card mb-2';
                card.innerHTML = `
                    <div class="card-body py-2 d-flex align-items-center">
                        <img src="${petImage}" class="rounded-circle me-3" width="50" height="50" style="object-fit: cover;">
                        <div class="flex-grow-1">
                            <strong>${pet.name}</strong>
                            <small class="text-muted d-block">${pet.breed}, ${pet.age}살</small>
                        </div>
                        <div>
                            <button class="btn btn-sm btn-outline-primary btn-edit">수정</button>
                            <button class="btn btn-sm btn-outline-danger ms-1 btn-delete">삭제</button>
                        </div>
                    </div>
                `;
                card.querySelector('.btn-edit').addEventListener('click', () => openPetModal(petModal, pet));
                card.querySelector('.btn-delete').addEventListener('click', () => deletePet(pet.id, petModal));
                container.appendChild(card);
            });
        } catch (error) {
            console.error(error);
            alert(error.message);
        }
    }

    function openPetModal(petModal, pet = null) {
        const modalLabel = document.getElementById('petModalLabel');
        document.getElementById('pet-form').reset();
        document.getElementById('pet-image-input').value = '';
        const preview = document.getElementById('pet-image-preview');
        if (pet) {
            modalLabel.textContent = '반려견 정보 수정';
            document.getElementById('pet-id').value = pet.id;
            document.getElementById('pet-name').value = pet.name;
            document.getElementById('pet-breed').value = pet.breed;
            document.getElementById('pet-age').value = pet.age;
            document.getElementById('pet-gender').value = pet.gender;
            document.getElementById('pet-introduction').value = pet.introduction;
            preview.src = pet.profileImageUrl || '/images/default_pet_profile.png';
        } else {
            modalLabel.textContent = '새 반려견 등록';
            document.getElementById('pet-id').value = '';
            preview.src = '/images/default_pet_profile.png';
        }
        petModal.show();
    }

    function previewPetImage(event) {
        const file = event.target.files[0];
        if (file) {
            document.getElementById('pet-image-preview').src = URL.createObjectURL(file);
        }
    }

    async function handlePetFormSubmit(petModal) {
        const petId = document.getElementById('pet-id').value;
        const petData = {
            name: document.getElementById('pet-name').value,
            breed: document.getElementById('pet-breed').value,
            age: document.getElementById('pet-age').value,
            gender: document.getElementById('pet-gender').value,
            introduction: document.getElementById('pet-introduction').value,
        };
        const isUpdate = !!petId;
        const url = isUpdate ? `/api/pets/${petId}` : '/api/pets';
        const method = isUpdate ? 'PUT' : 'POST';
        try {
            const response = await fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(petData),
            });
            if (!response.ok) throw new Error('정보 저장에 실패했습니다.');

            const savedPet = await response.json();
            const imageFile = document.getElementById('pet-image-input').files[0];

            if (imageFile) {
                const formData = new FormData();
                formData.append('image', imageFile);
                const imageResponse = await fetch(`/api/pets/${savedPet.id}/image`, {
                    method: 'POST',
                    body: formData,
                });
                if (!imageResponse.ok) throw new Error('이미지 업로드에 실패했습니다.');
            }

            petModal.hide();
            await loadUserPets(petModal);
        } catch (error) {
            console.error(error);
            alert(error.message);
        }
    }

    async function deletePet(petId, petModal) {
        if (!confirm('정말로 이 프로필을 삭제하시겠습니까?')) return;
        try {
            const response = await fetch(`/api/pets/${petId}`, {
                method: 'DELETE'
            });
            if (!response.ok) throw new Error('삭제에 실패했습니다.');
            await loadUserPets(petModal);
        } catch (error) {
            console.error(error);
            alert(error.message);
        }
    }
</script>
</body>
</html>